<!DOCTYPE html>
<!--Below we define the language-->
<html lang="en-UK">

<head>
	<meta charset="utf-8">
	<!--This links this page to the CSS style sheet-->
	<link rel="stylesheet" type="text/css" href="/css/Cereal.CSS">

	<!--The next three tags are needed for Jquerry mobile to work-->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <!-- <script type="text/javascript" src="cordova.js"></script> -->

    <!-- Google Fonts - these look nice! -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:100,200,300,400,400italic,500,600,700,700,800,900italic&amp;subset=latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese' rel='stylesheet' type='text/css' />
    <link href='https://fonts.googleapis.com/css?family=ABeeZee:100,200,300,400,400italic,500,600,700,700,800,900italic&amp;subset=latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese' rel='stylesheet' type='text/css' />

    <link href='https://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet'>

    <!-- CSS - using bootstrap and also another one I found-->
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' type='text/css' />
    <link rel='stylesheet' href='https://www.websocket.org/css/style.css' type='text/css' />

    <style>

        body{font-family: 'Aldrich'}
        h1 {font-family: 'Aldrich';}
        h3 {font-family: 'Aldrich'}
        button {font-family: 'Aldrich'}
.navbar li {font-family: 'Aldrich';}

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #f2f2f2;
            margin: 50% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 160px; /* Could be more or less, depending on screen size */
        }

        .loader {
            border: 16px solid #d3d3d3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

<!-- Here is the title-->
<title>RoboCereal</title>
</head>

<script>
    var wsUri;
    var startlogin;
    var connectBut;
    var disconnectBut;
    var sendMessage;
    var sendBut;
    var clearLogBut;
    var getTempHumid;
    var timeout

    function echoHandlePageLoad() {
        //default to homepage
        window.location.hash = '#Home';

        wsUri = document.getElementById('wsUri');
        wsUri.value = 'ws://192.168.1.67:301/';//'ws://echo.websocket.org';

        //get password from storage if possible
        var passwordstart = localStorage.getItem('passwordx');
        document.getElementById('password').value = passwordstart;

        if (wsUri != "" && passwordstart != "") {
            startlogin = "1"
            doConnect()
        }
        else{
            startlogin = "0"
        }
    }



    //connection function
    function doConnect() {

        var uri = wsUri.value;

        //show modal
        document.getElementById('myModal1').style.display = "block";


        //timeout after 15 seconds
        setTimeout(function() {
         	if (websocket.readyState != WebSocket.OPEN) {
         		websocket.close();
		}
        }, 15000);

        websocket = new WebSocket(uri);
        websocket.onopen = function(evt) {
            onOpen(evt)
        };
        websocket.onclose = function(evt) {
            onClose(evt)
        };
        websocket.onmessage = function(evt) {
            onMessage(evt)
        };
        websocket.onerror = function(evt) {
            onError(evt)
        };
    }


    //disconnection function
    function doDisconnect() {
        websocket.close();
        document.getElementById('connect').innerHTML = 'Connect';
        document.getElementById('connect').setAttribute("onClick","doConnect()");
        wsUri.disabled = false;
        document.getElementById('password').disabled = false;
    }

    //button 1
    function doButton1() {
        websocket.send("LED1");
        //put in "no connection!" code
    }


    //websocket started
    function onOpen(evt) {
        console.log('CONNECTED');
        var pass = 'PW#' + document.getElementById('password').value;
        websocket.send(pass)

        //get temp and humidity periodically - change update time here
        //getTempHumid = setInterval(getTempHumidity, 3000);

    }

    //get temp and humidity periodically called regularly
    //function getTempHumidity() {
        //websocket.send("getTH");
    //}

    //websocket closed
    function onClose(evt) {
        console.log('DISCONNECTED');
        console.log(evt)
        wsUri.disabled = false;
        document.getElementById('password').disabled = false;
        
        //if disconnect caused by client timeout
        if (evt.code == 1006) {
        	modalDelay(0,2000,'Connection failed','Connect',"doConnect()",'#Settings');  
        }
    }

    function savePass(){
        localStorage.setItem('passwordx', document.getElementById('password').value);
    }

    //handle connection modals - this code is awful but it works!
    function modalDelay(time1,time2,modalhtml1,modalhtml2,buttonfunc,startpage){
            setTimeout(function() {
            document.getElementById('modaltext1').innerHTML = modalhtml1;
            setTimeout(function() {
                  document.getElementById('myModal1').style.display = "none";
                  document.getElementById('connect').innerHTML = modalhtml2;
                  document.getElementById('connect').setAttribute("onClick",buttonfunc);
                  document.getElementById('modaltext1').innerHTML = 'Connecting';
                  startlogin = "0"
                  window.location.hash = startpage
                }, time2);
        }, time1);  
    }

    //message recieved
    function onMessage(evt) {

        var datain = String(evt.data);
        console.log(datain);

        //interprits password response
        if (datain.substring(0,3) == "P#G") {
            modalDelay(2000,2000,'Connection successful!','Disconnect',"doDisconnect()",'#Home',false);
            wsUri.disabled = true;
            document.getElementById('password').disabled = true;       
        }
        else if (datain.substring(0,3) == "P#B") {
            websocket.close();
            modalDelay(2000,2000,'Incorrect Password','Connect',"doConnect()",'#Settings',false);
            doDisconnect()         
        }


        // //interprits data from sensors (H: is humidity and T: is temperature)
        // else if (datain.includes('H:')) {
        //     document.getElementById('humidity').innerHTML = "Humidity = " + datain.substring(datain.indexOf(":") + 1) + "%";
        // } else if (datain.includes('T:')) {
        //     document.getElementById('temperature').innerHTML = "Temperature = " + datain.substring(datain.indexOf(":") + 1) + "&deg";
        // }


    }

    //error recieved
    function onError(evt) {
        //special error handling here?
        //console.log(evt)
    }

    window.addEventListener('load', echoHandlePageLoad, false);
</script>


<!--HOME PAGE CODE-->
<body>
	            <!-- The Modal -->
	            <div id="myModal1" class="modal"><!-- class="modal"> -->
              <!-- Modal content -->
              <div class="modal-content">
                <div class="text-center"><strong id="modaltext1">Connecting</strong></div>
                <br>
                <br>
                <div class="loader"></div>
              </div>
            </div>

	<div data-role="page" id="Home">
		<div data-role="header" style="overflow:hidden;">
		
			<h1 Title ="The worlds first automatic cereal dispeser" class="center">RoboCereal</h1>
           
		</div>
		<div data-role="main" class="ui-content">
            <div class="center">
			<br>
			
			<br>
			<button type="button" id="button1" class="btn btn-primary" onclick="doButton1()">Make Cereal now</button>
            <br>


        </div>

		</div>
        <div data-role="footer" data-position="fixed" data-tap-toggle="false">
            <div data-role="navbar">
                <ul>
                    <li><a href="#Settings" data-icon="gear"></a></li>
                    <li><a href="#Home" data-icon="home"></a></li>
                    <li><a href="#Timer" data-icon="clock"></a></li>
                    
                </ul>
            </div>

        </div>

	</div>


<!--SETTINGS PAGE-->
<div data-role="page" id="Settings">
	<div data-role="header">
	
		<h1 Title ="The worlds first automatic cereal dispeser" class="center">RoboCereal</h1>
        <a href='#IP' data-icon="star" class="ui-btn-right">IP details</a>
	</div>
	<div data-role="main" class="ui-content">
		<h3 class="center">Select your cereal</h3>
			<select name="Types of Cereal" >
				<option value="Cornflakes">Cornflakes</option>
	  			<option value="Alpen" >Alpen</option>
	  			<option value="Cocopops" >Cocopops</option>
			</select>
            <br>
		<h3 class="center">Select how much milk you'd like (ml)</h3>
			<input type="range" min="0" max="500" id=myRange value="250">

		<h3 class="center">Select how much cereal you'd like (g)</h3>
			<input type="range" id="myRange" min="0" max="100" value="50">

			<script>
			function myFunction() {
			    var x = document.getElementById("myRange").value;
			    document.getElementById("demo").innerHTML = x;
			}
			</script>
	
            <br>
   

    </div>

        <div data-role="footer" data-position="fixed" data-tap-toggle="false">
            <div data-role="navbar">
                <ul>
                    <li><a href="#Settings" data-icon="gear"></a></li>
                    <li><a href="#Home" data-icon="home"></a></li>
                    <li><a href="#Timer" data-icon="clock"></a></li>
                    
                </ul>
            </div>

        </div>
</div>



<!--TIMER PAGE-->
<div data-role="page" id="Timer">
	<div data-role="header">
	
		<h1 Title ="The worlds first automatic cereal dispeser" class="center">RoboCereal</h1>
	</div>
	<div data-role="main" class="ui-content">
	

	<h3 class="center">Set the time you'd like your cereal to be dispensed</h3>
		
	</div>
    <div data-role="footer" data-position="fixed" data-tap-toggle="false">
        <div data-role="navbar">
                <ul>
                    <li><a href="#Settings" data-icon="gear"></a></li>
                    <li><a href="#Home" data-icon="home"></a></li>
                    <li><a href="#Timer" data-icon="clock"></a></li>
                    
                </ul>
        </div>

    </div>

</div>

<!--TIMER PAGE-->

<div data-role="page" id="IP">
    <div data-role="header">
    
        <h1 Title ="The worlds first automatic cereal dispeser" class="center">RoboCereal</h1>
    </div>
    <div data-role="main" class="ui-content">
    
         <h3 class="center">Set your IP details</h3>
        <form class="center">
            IP:<br>
            <input type="text" id="wsUri">

            Password:<br>
            <input type="text" id="password" onblur="savePass()">

            <!-- connect button is dynamic -->
            <button type="button" id="connect" class="btn btn-primary" onclick="doConnect()">Connect</button>

        </form> 
    
        
    </div>
    <div data-role="footer" data-position="fixed" data-tap-toggle="false">
        <div data-role="navbar">
                <ul>
                    <li><a href="#Settings" data-icon="gear"></a></li>
                    <li><a href="#Home" data-icon="home"></a></li>
                    <li><a href="#Timer" data-icon="clock"></a></li>
                    
                </ul>
        </div>

    </div>

</div>

</body>
</html>
